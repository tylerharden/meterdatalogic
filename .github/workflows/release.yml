name: Release meterdatalogic

on:
    workflow_dispatch:
        inputs:
            version:
                description: "Version to release (e.g. 0.1.4)"
                required: true
    push:
        tags:
            - "v*.*.*"

permissions:
    contents: write
    id-token: write  # Required for PyPI trusted publishing

jobs:
    build-and-release:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Set version from input or tag
              id: ver
              run: |
                  if [ -n "${{ github.event.inputs.version }}" ]; then
                    V="${{ github.event.inputs.version }}"
                  else
                    # strip leading 'v' from tag
                    T="${GITHUB_REF_NAME#v}"
                    V="$T"
                  fi
                  echo "version=$V" >> $GITHUB_OUTPUT
                  echo "Release version: $V"
                  
                  # Detect pre-release (alpha, beta, rc, dev, a, b, etc.)
                  if echo "$V" | grep -qE '(alpha|beta|rc|dev|a[0-9]|b[0-9])'; then
                    echo "is_prerelease=true" >> $GITHUB_OUTPUT
                    echo "Detected pre-release version"
                  else
                    echo "is_prerelease=false" >> $GITHUB_OUTPUT
                    echo "Detected stable release"
                  fi

            - name: Verify pyproject version matches
              run: |
                  VY=$(python -c 'import tomllib,sys;print(tomllib.load(open("pyproject.toml","rb"))["project"]["version"])')
                  if [ "$VY" != "${{ steps.ver.outputs.version }}" ]; then
                    echo "pyproject version ($VY) does not match release version (${{ steps.ver.outputs.version }})" >&2
                    exit 1
                  fi

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.11"

            - name: Install build tooling
              run: |
                  python -m pip install --upgrade pip build

            - name: Build wheel and sdist
              run: |
                  python -m build
                  ls -lh dist/

            - name: Create Git tag (if manual dispatch)
              if: ${{ github.event_name == 'workflow_dispatch' }}
              run: |
                  git config user.name "github-actions"
                  git config user.email "github-actions@github.com"
                  git tag -a "v${{ steps.ver.outputs.version }}" -m "Release v${{ steps.ver.outputs.version }}"
                  git push origin "v${{ steps.ver.outputs.version }}"

            - name: Publish to PyPI
              uses: pypa/gh-action-pypi-publish@release/v1
              with:
                  print-hash: true

            - name: Create GitHub Release
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: v${{ steps.ver.outputs.version }}
                  name: v${{ steps.ver.outputs.version }}
                  draft: false
                  prerelease: ${{ steps.ver.outputs.is_prerelease }}
                  files: |
                      dist/*.whl
                      dist/*.tar.gz
